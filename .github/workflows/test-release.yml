name: Build Test Release (Fork)

# Trigger on tags prefixed with 'test-' or 'fork-' to avoid conflict with upstream releases
on:
  push:
    tags:
      - 'test-*'
      - 'fork-*'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Test version tag (e.g., test-0.11.1-fix)'
        required: true
        default: 'test-0.11.1'

env:
  PLUGIN_NAME: obsidian-toggl-integration-fork

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test
        continue-on-error: true  # Don't block test releases on test failures

      - name: Build plugin
        id: build
        run: |
          npm run build
          mkdir -p ${{ env.PLUGIN_NAME }}
          cp main.js manifest.json styles.css ${{ env.PLUGIN_NAME }}/
          zip -r ${{ env.PLUGIN_NAME }}.zip ${{ env.PLUGIN_NAME }}
          
          # Extract version from tag or input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version_tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Built version: $VERSION"

      - name: Create Test Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.build.outputs.version }}
          release_name: 'Test Build ${{ steps.build.outputs.version }}'
          body: |
            ## Test Build (Fork)
            
            This is a test build for fork development. **Not for production use.**
            
            ### Changes in this test build:
            - Enhanced API connectivity diagnostics
            - Fallback direct v9 endpoint testing
            - Improved error logging for Toggl API failures
            
            ### Installation:
            1. Download `obsidian-toggl-integration-fork.zip`
            2. Extract to your Obsidian vault's `.obsidian/plugins/` directory
            3. Reload Obsidian
            4. Enable plugin and check console (Ctrl+Shift+I) for `[toggl]` diagnostic logs
            
            **Note:** This will install alongside (not replace) the official plugin if you have both.
          draft: true  # Start as draft so you can review before publishing
          prerelease: true

      - name: Upload plugin zip
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.PLUGIN_NAME }}.zip
          asset_name: ${{ env.PLUGIN_NAME }}-${{ steps.build.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload main.js
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./main.js
          asset_name: main.js
          asset_content_type: text/javascript

      - name: Upload manifest.json
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./manifest.json
          asset_name: manifest.json
          asset_content_type: application/json

      - name: Upload styles.css
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./styles.css
          asset_name: styles.css
          asset_content_type: text/css

      - name: Build Summary
        run: |
          echo "### Test Build Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [View Draft Release](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the draft release, then publish when ready for testing." >> $GITHUB_STEP_SUMMARY
